# AWS server infra

This project writes the basic infrastructure of our AWS server.

## Basic components

- VPC (use default)
- Security Group
  - webserver
  - database
- EC2 (for webserver)
- RDS (for database)

## To use this

You need to add credentials into `~/.aws/credentials` file. The content will be like follows

```
[default] # this is the default profile
aws_access_key_id=xxxxx
aws_secret_access_key=xxxxx

[aws_free] # profile to be added
aws_access_key_id=xxxxx
aws_secret_access_key=xxxxx
```

### (Optional) Install terraform via tfenv

```bash
# install tfenv via homebrew
brew install tfenv

# install terraform
tfenv install 1.9.3

# change terraform version
tfenv use 1.9.3
```

### Install terraform

Please install via the commands below. Note that our current working terraform version is 0.12.23

```bash
# for MacOS
brew install terraform
```

### Create tfvars

Please make a copy of the `terraform.tfvars.template` into `terraform.tfvars` and change the content accordingly.

| variable               | description                                           | sample value |
| -----------------------| ----------------------------------------------------- | - |
| sg_whitelisted_pub_ips | Public ips to be whitelisted for accessing ec2 server | `["0.0.0.0/0"]` |
| ec2_image_id           | The AMI of the image for ec2 server. __Optional__. If specified, the `ec2_os` will be ignored | `ami-003c463c8207b4dfa` |
| ec2_os                 | The OS of the ec2 server, will map to some pre-defined AMI. Can be overwritten by `ec2_image_id` | `linux`, `ubuntu`, `debian` |
| db_rds_name            | The instance name of the RDS | `instance-name` |
| db_database_name       | The name of the default database | `database-name` |
| db_master_username     | The master username for accessing the RDS | `username` |
| db_engine              | DB engine name | `postgres`, `mysql` |
| db_engine_version      | Version of the DB engine | `12.19` |


### To review the plan

```bash
terraform plan
```

### To apply the plan

```bash
terraform apply
```

### !!IMPORTANT To get credentials

There are 2 credentials being generated by the terraform code.
- Password of the master user for the RDS
- Private key for accessing the EC2 server

To get the credentials, use the following commands

```bash
terraform output private_key
terraform output db_password

# or, you can output the private key directly
terraform output private_key > ~/.ssh/aws_ec2_private.pem
chmod 400 ~/.ssh/aws_ec2_private.pem

# to access your ec2 server
ssh -i ~/.ssh/aws_ec2_private.pem username@server
```
